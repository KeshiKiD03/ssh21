-----------
-- SSH21 --
-----------

<!---
# Plantilla H1
## Plantilla H2
### Plantilla H3
-->
<!--- <img src="https://phoneky.co.uk/thumbs/screensavers/down/original/linux_3rj131p8.gif" />
-->

â­ï¸ **PLANTILLA** â­ï¸

| ðŸ”¥PLANTILLA TALBAâ—ðŸ”¥ | 
| ------------- |
| *Plantilla* |


--------------------------------------------------------------------------------

**Utilitats client**

--
scp --> Secure Copy


--
sudo apt-get install -y sshfs
--
fuser
--
dpkg -l sshfs | grep bin
--
dpkg -L sshfs | grep bin
--
sshfs unix01@ssh.edt.org: /tmp/mnt
--
ls -la /tmp/mnt
--
mount -t fuse.sshfs
--
fusermount -u /tmp/mnt
--
mount -t fuse.sshfs
--
sshfs unix01@ssh.edt.org:/usr/share/doc /tmp/mnt
--
cp a
--
fusermount -u /tmp/mnt
--
fuser -v /tmp/mnt
--
lsof /tmp/mnt
--
**Deberes**
--
Encender: Ldap (d) + SSH (d) + Portainer (d)
Crear un desplegamiento con docker-compose

Docker Compose es un fichero YAML, se despliega con 1 host. 
- Instalar docker swap
- VersiÃ³ actual del llenguatge
--

--
**DOCKER COMPOSE**

Compose is a tool for defining and running multi-container Docker applications. With Compose, you use a YAML file to configure your applicationâ€™s services. Then, with a single command, you create and start all the services from your configuration. To learn more about all the features of Compose, see the list of features.

Compose es una herramienta para definir y arrancar multi-container Docker apps. Con compose puedes usar un archivo YAML para configurar los servicios de tus aplicaciones. Con un solo comando puedes crear e iniciar todos los servicios de tu c onfiguraciÃ³n.
--

## InstalaciÃ³n.

1. Run this command to download the current stable release of Docker Compose:
```
sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
1. Run this command to download the current stable release of Docker Compose:
```
2. Apply executable permissions to the binary:
```
sudo chmod +x /usr/local/bin/docker-compose
```
Note: If the command docker-compose fails after installation, check your path. You can also create a symbolic link to /usr/bin or any other directory in your path

3. Test the installation.
```
docker-compose --version
```

Language reference = diccionari 
Install

[REPASAR]

--





keshi@KeshiKiD03:~/Documents$ docker-compose up -d

Creating network "documents_2hisx" with the default driver
Creating network "documents_default" with the default driver
Creating ssh.edt.org ... 
Creating portainer.edt.org ... 
Creating ldap.edt.org      ... 





Aprofitar per entendre els conceptes:


â— Desplegament

Con Dockerfile tenemos una receta para desplegar un contenedor (o container). Con docker-compose tenemos pues una receta para desplegar un conjunto de contenedores que interactuarÃ¡n entre ellos.


â— Xarxes

Estan los 3 en una red interna. Se comunican con los respectivos puertos deffinidos.


â— Serveis

SSH y LDAP con autenticaciÃ³n de PAM. Y el portainer para verificar las mÃ¡quinas.


â— InstÃ ncies

Conjunto de contenedores desplegados por docker-compose.






24.11.21 - PrÃ¡ctica 14 [SSH con Docker-compose]

1. Instalar el Docker Compose.
2. Configurar el fichero YAML.

--
version: "3.8"
services:
  ldap:
    image: keshikid03/ldap21:group
    container_name: ldap.edt.org
    hostname: ldap.edt.org
    ports: 
      - "389:389"
      - "636:636"
    networks:
     - 2hisx
  ssh:
    image: keshikid03/ssh21:base
    container_name: ssh.edt.org
    hostname: ssh.edt.org
    ports:
      - "2022:22"
    networks:
     - 2hisx
  portainer:
    image: portainer/portainer
    container_name: portainer.edt.org
    hostname: portainer.edt.org
    ports: 
     - "9000:9000"
    volumes:
     - /var/run/docker.sock:/var/run/docker.sock 
networks:
  2hisx:

--

3. Verificamos 

isx36579183@i11:~/Documents/ssh21/ssh21:base$ docker-compose up -d
Creating network "ssh21base_2hisx" with the default driver
Creating network "ssh21base_default" with the default driver
Creating ssh.edt.org       ... done
Creating portainer.edt.org ... done
Creating ldap.edt.org      ... done
isx36579183@i11:~/Documents/ssh21/ssh21:base$ docker ps
CONTAINER ID   IMAGE                     COMMAND                  CREATED          STATUS          PORTS                                                                          NAMES
2eeba994ff59   keshikid03/ssh21:base     "/bin/sh -c /opt/docâ€¦"   12 seconds ago   Up 11 seconds   0.0.0.0:2022->22/tcp, :::2022->22/tcp                                          ssh.edt.org
b7f8e122344c   keshikid03/ldap21:group   "/bin/sh -c /opt/docâ€¦"   12 seconds ago   Up 11 seconds   0.0.0.0:389->389/tcp, :::389->389/tcp, 0.0.0.0:636->636/tcp, :::636->636/tcp   ldap.edt.org
aa0ee33e0956   portainer/portainer       "/portainer"             12 seconds ago   Up 11 seconds   0.0.0.0:9000->9000/tcp, :::9000->9000/tcp                                      portainer.edt.org


--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

--

Listen

Bind

Pont 

Interficie

Els ports son 16 bits.

**ps ax**

#Dominar las ordenes

nmap

ss --> VersiÃ³n moderna del Netstat

netstat

ss -l

--
Netid   State    Recv-Q    Send-Q               Local Address:Port         Peer Address:Port   Process   
nl      UNCONN   0         0                             rtnl:kernel                   *                 
nl      UNCONN   0         0                             rtnl:3510                     *                 
nl      UNCONN   4352      0                          tcpdiag:ss/132                   *                 
nl      UNCONN   768       0                          tcpdiag:kernel                   *                 
nl      UNCONN   0         0                             xfrm:kernel                   *                 
nl      UNCONN   0         0                            audit:kernel                   *                 
nl      UNCONN   0         0                        fiblookup:kernel                   *                 
nl      UNCONN   0         0                              nft:kernel                   *                 
nl      UNCONN   0         0                           uevent:kernel                   *                 
nl      UNCONN   0         0                             genl:kernel                   *                 
u_str   LISTEN   0         128          /var/run/nslcd/socket 69845                   * 0                
udp     UNCONN   0         0                       127.0.0.11:38872             0.0.0.0:*                
tcp     LISTEN   0         4096                    127.0.0.11:46761             0.0.0.0:*                
tcp     LISTEN   0         128                        0.0.0.0:22                0.0.0.0:*                
tcp     LISTEN   0         128                           [::]:22                   [::]:*  
--

0.0.0.0 --> Para todas las interfÃ­cies

0.0.0.0:* --> Todos los clientes se pueden conectar

0.0.0.0:22 --> EstÃ¡ escuchando por el puerto 22

ss -lt --> Listen TCP

ss -lu --> Listen UDP

ss -lx --> Listen Unix

ss -u

bootpc -->

bootps -->

ss -un

68 --> Puertos DHCP

67 --> Puertos DHCP

ss -x --> Sockets unix

-----------------

find / -type s -ls 2> /dev/null

-----------------

ss -lt --> Todo de TCP

ss -lx --> te lo muestra todo de UNIX

-----------------

cd /etc/ssh 

ls -l 

Son claves del HOST privada y pÃºblica 

-rw------- 1 root root   1385 Nov 18 11:21 ssh_host_dsa_key
-rw-r--r-- 1 root root    606 Nov 18 11:21 ssh_host_dsa_key.pub
-rw------- 1 root root    513 Nov 18 11:20 ssh_host_ecdsa_key
-rw-r--r-- 1 root root    179 Nov 18 11:20 ssh_host_ecdsa_key.pub
-rw------- 1 root root    411 Nov 18 11:20 ssh_host_ed25519_key
-rw-r--r-- 1 root root     99 Nov 18 11:20 ssh_host_ed25519_key.pub
-rw------- 1 root root   2602 Nov 18 11:20 ssh_host_rsa_key
-rw-r--r-- 1 root root    571 Nov 18 11:20 ssh_host_rsa_key.pub


------------------------------------------------------------------

vim sshd_config

Port 22

ListenAddress 0.0.0.0

--

Port 2022

ListenAddress 127.0.0.1

--


localhost --> ::1 Ipv6

127.0.0.1 IPv4

--------------

reiniciar el servicio

kill -1 [numero de proceso]

-1 reinicializar sithub

nmap localhost

-------------------

Decirle que IP si

0.0.0.0 --> Todas las IP que tenga este HOST.

ssh -p [2022] unix@172.19.0.3 --> No estÃ¡ encendido el container




Cambiar el sshd_config


**Probar la conectividad**

isx36579183@i11:~/Documents/ssh21/ssh21:base$ ssh -p 2022 unix01@172.19.0.3
The authenticity of host '[172.19.0.3]:2022 ([172.19.0.3]:2022)' can't be established.
ECDSA key fingerprint is SHA256:jq6jYl3d6SoyiJeSISMMsvOJHSaOLRA+PXsROlzXH0E.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '[172.19.0.3]:2022' (ECDSA) to the list of known hosts.
unix01@172.19.0.3's password: 
unix01@ssh:~$ 

--
# Authentication:

#LoginGraceTime 2m
#PermitRootLogin prohibit-password
#StrictModes yes
#MaxAuthTries 6 --> Maximos intentos
#MaxSessions 10 --> Maximas sesiones abiertas

#PubkeyAuthentication yes --> Explica que se puede iniciar con claves pÃºblicas

--

Son directivas de configuraciÃ³n del SSHD

#LoginGraceTime 2m --> El servidor se desconecta despuÃ©s de este tiempo si el usuario no ha iniciado sesiÃ³n correctamente. Default 120 s.

#PermitRootLogin prohibit-password --> No se permite acceder al SSH como ROOT. Permit LOGIN NO

#StrictModes yes --> Especifica el tipo de modo de ficheros. [falta rellenar]

# PrintMotd --> Es el mensaje del dia para decirles a los empleados.

Con la / y se busca y n de next

Vim /etc/motd --> Especificar el fichero del mensaje del dÃ­a

/etc/init.d/ssh restart

Probar el SSH

--
isx36579183@i11:~/Documents/ssh21/ssh21:base$ ssh -p 2022 unix01@172.19.0.3
unix01@172.19.0.3's password: 
Last login: Thu Nov 18 12:08:25 2021 from 172.19.0.1

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.

Portat bÃ© o al carrÃ©
unix01@ssh:~$ 

--


banner --> Encabezado

Match host 172.19.0.1

	banner /etc/banner
	
--

Match user unix01
	banner /etc/banner-user01
	PasswordAuthentication yes
	
Match user unix02
	banner /etc/banner-user02
	PasswordAuthentication no

Cuando se conecte unix01 se conectaran unas normas y cuando se conecte unix02 se conectarÃ¡n otras



----------------------

AllowUsers / DenyUsers

Permite una lista de usuarios que permite/denegar acceder por SSH.


The
             allow/deny users directives are processed in the following order: DenyUsers, AllowUsers.


----------------------

Ejercicio

man pam_access

man access.conf --> Como funciona el acecso

Se pueda iniciar todos los usuarios menos unix02

man pam_listfile 



















--------------------------------------------------------------------


Conceptos de REDES









































































**apt-get install openssh-server**

**yes**

**/usr/sbin/sshd (Daemon)**

**ssh guest@i27**

**patata**

--
The authenticity of host 'i27 (10.200.243.227)' can't be established.
ECDSA key fingerprint is SHA256:N/Bx0WtXgS1RXliXUPxQFckOyooabdz6EetsEdtkC94.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added 'i27,10.200.243.227' (ECDSA) to the list of known hosts.
guest@i27's password: 
Linux i27 5.10.0-8-amd64 #1 SMP Debian 5.10.46-4 (2021-08-03) x86_64

Linux i27 5.10.0-8-amd64 #1 SMP Debian 5.10.46-4 (2021-08-03) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Wed Nov 17 08:24:41 2021 from 10.200.243.202


--

ExplicaciÃ³n: Cuando el cliente se conecta con el servidor, el servidor dice que la autenticidad del host i27 no puede estar establecida. 
La mÃ¡quina a la que has llamado, la mÃ¡quina destino tiene un **fingerprint**. 
Fingerprint vocal.
La mÃ¡quina en la que se ha conectado le ha dado un **fingerprint** en modo de **HASH**
HASH MD5 y SHA[MEDIDA]
El fingerprint real del servidor te lo tienen que decir para poder conectarse.

El cliente anota el fingerprint del servidor, si se vuelve a abrir el SSH, ya no pide le fingerprint.

El fingerprint se calcula mediante una llave. El **hash** es la clave de host.

Se almacenan en .ssh/known_hosts --> Es donde se almacenan los fingerprints de los hosts

CLIENTE ----------------> SERVIDOR

Sshclient


**vim /etc/hosts**

10.200.243.226 i27

--
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@       WARNING: POSSIBLE DNS SPOOFING DETECTED!          @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
The ECDSA host key for i27 has changed,
and the key for the corresponding IP address 10.200.243.226
is unknown. This could either mean that
DNS SPOOFING is happening or the IP address for the host
and its host key have changed at the same time.
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
Someone could be eavesdropping on you right now (man-in-the-middle attack)!
It is also possible that a host key has just been changed.
The fingerprint for the ECDSA key sent by the remote host is
SHA256:4qz/8/bGbpqZpC8G2j7eUaFrqwF/OvunIxwfsfv37XM.
Please contact your system administrator.
Add correct host key in /root/.ssh/known_hosts to get rid of this message.
Offending ECDSA key in /root/.ssh/known_hosts:1
  remove with:
  ssh-keygen -f "/root/.ssh/known_hosts" -R "i27"
ECDSA host key for i27 has changed and you have requested strict checking.
Host key verification failed.

--

Dice que han habido cambios y que te pueden estar hackeando o escuchando.

La fingerprint enviada del host es diferente a lo que tiene apuntado.


**ssh-keyscan i26**


--

isx36579183@i11:~/Documents/pam21$ ssh-keyscan i26
# i26:22 SSH-2.0-OpenSSH_8.4p1 Debian-5
i26 ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDlFgGZWfp6+uLa6qzmHDg9jT3+FrtA4tSrtrDOcnF1QTOG6FBwhdLA++XziA/PD2T7EsRXqWmtjQ3lU1+ikIyck4g52Q7VOJTlSz1YZRFh4HYCJqFLUz3BATH7scESqXv8NzVcilQy+5KfIQCSYtP55rZ2hcxHNgjEfHFEIjaQrJRwW+D13senMrh+VaFDdZtziiKvvSjwrmLoGbcxBFhQf2jk/b+yBBZhqfwixlpXb4f5lDzNNS+f+jAIA/jPUpSxzMtzwroIaG3CJMnfBQdkd3UjN9T88VBUxvBVC6UbypSRYZsPoRWUuC4iTwRmIHy/qP6zXwXXFz6+VQ1T6HBbXWGpsAApohNVzRgly/APxmm/gvH8XDmNE4Vu9ltQN+nltBi5c8gkTSfhnVGViL9oqdHiCg5+zoaGyt4OEfqUMZXnIKF1ws2BmP9EdNRQg7IOs+N26BMGIBFJo8afFgxqDvrRyOj5R3dcVjMs6jXUHbp+aSjh/s936xdAbU+9Fm8=
# i26:22 SSH-2.0-OpenSSH_8.4p1 Debian-5
i26 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBP7OkfWoUX+gRX2KyQvPC/5yCC52UUOAzFmyMZrq2gEsbJV+K1XkY6Xc/wbzANH2Plosd86o+xtWz0M9UzvaFd4=
# i26:22 SSH-2.0-OpenSSH_8.4p1 Debian-5
i26 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINs01uNs6AU52uwYhNVCBvYihQcSMeTYo1QHRHMT1Wel
# i26:22 SSH-2.0-OpenSSH_8.4p1 Debian-5
# i26:22 SSH-2.0-OpenSSH_8.4p1 Debian-5

--

Dice las claves de host de SSH de i26

Cuando se ha instalado el Openssh-server, se han creado automÃ¡ticamente las claves de host.

known_hosts --> Es la lista de fingerprints, que el usuario ha dado como aceptables a la hora de entrar. Es decir que ha aceptado el fingerprint del servidor.

**cat ~/.ssh/known_hosts**

--
|1|W6RPlVuD8uqOVw7sLDCyMFKPoPA=|rQ8QEG+54oC1/tPVnPJ7rdgUhbg= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMzAza02PRtaaYGcGC5KJCmh1uUReCUBU5V8mcIgOCeTGFlpM5l1n5YO4MxrvOLa5i3gbolZ9hArCD7MYAzRGwY=
|1|ms4ytWDTbvB59PgBA4K5ZN1siME=|o/qR3IPIxeFPbAq0gYowmcJlF30= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMzAza02PRtaaYGcGC5KJCmh1uUReCUBU5V8mcIgOCeTGFlpM5l1n5YO4MxrvOLa5i3gbolZ9hArCD7MYAzRGwY=

--

**md5sum /etc/passwd**
--
0cd28cd36e0974a41545b1fb9c2598b1  /etc/passwd

--
Es el hash de todo /etc/passwd


Si se cambia algo se cambia el fingerprint.

--
root@pam:/opt/docker# md5sum /tmp/passwd
0cd28cd36e0974a41545b1fb9c2598b1  /tmp/passwd
root@pam:/opt/docker# md5sum /tmp/passwd
0cd28cd36e0974a41545b1fb9c2598b1  /tmp/passwd
root@pam:/opt/docker# vim /tmp/passwd
root@pam:/opt/docker# md5sum /tmp/passwd
98e0e82968fc92e2fd68ccf4768ed161  /tmp/passwd

--

Checksum --> Retransmitir, de la suma.

DispersiÃ³n --> Mucha cantidad de datos y concentras en algo mÃ¡s pequeÃ±o. Hay 

Eliminar ultima lines del etc hosts. Entrar a i27:
root@pam:/opt/docker# ssh -o "VisualHostKey yes" guest@i27
: patata
$ su -
:jupiter
# cd /etc/ssh/
# tree


--
Host key fingerprint is SHA256:N/Bx0WtXgS1RXliXUPxQFckOyooabdz6EetsEdtkC94
+---[ECDSA 256]---+
|            .+XO%|
|             ==*+|
|        . o o ++o|
|         = B  o.o|
|      o S.& .. . |
|     . = BoE     |
|      + .o.      |
|     . .o..      |
|        o+       |
+----[SHA256]-----+
guest@i27's password: 
Linux i27 5.10.0-8-amd64 #1 SMP Debian 5.10.46-4 (2021-08-03) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Wed Nov 17 09:00:06 2021 from 10.200.243.209
guest@i27:~$ 

--

su - # jupiter

--
.
â”œâ”€â”€ moduli
â”œâ”€â”€ ssh_config
â”œâ”€â”€ ssh_config.d
â”œâ”€â”€ sshd_config
â”œâ”€â”€ sshd_config.d
â”œâ”€â”€ ssh_host_ecdsa_key
â”œâ”€â”€ ssh_host_ecdsa_key.pub
â”œâ”€â”€ ssh_host_ed25519_key
â”œâ”€â”€ ssh_host_ed25519_key.pub
â”œâ”€â”€ ssh_host_rsa_key
â””â”€â”€ ssh_host_rsa_key.pub

--

apt-get install mlocate (Lo hace solo el host)

**locate ssh.service**
--
/usr/lib/systemd/system/ssh.service
/usr/lib/systemd/system/sssd-ssh.service
/usr/share/doc/avahi-daemon/examples/sftp-ssh.service
/usr/share/doc/avahi-daemon/examples/ssh.service
/var/lib/systemd/deb-systemd-helper-enabled/ssh.service.dsh-also
/var/lib/systemd/deb-systemd-helper-enabled/sssd-ssh.service.dsh-also
/var/lib/systemd/deb-systemd-helper-enabled/multi-user.target.wants/ssh.service

--

**vim /usr/lib/systemd/system/ssh.service**

--
[Unit]
Description=OpenBSD Secure Shell server
Documentation=man:sshd(8) man:sshd_config(5)
After=network.target auditd.service
ConditionPathExists=!/etc/ssh/sshd_not_to_be_run

[Service]
EnvironmentFile=-/etc/default/ssh
ExecStartPre=/usr/sbin/sshd -t
ExecStart=/usr/sbin/sshd -D $SSHD_OPTS
ExecReload=/usr/sbin/sshd -t
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
Restart=on-failure
RestartPreventExitStatus=255
Type=notify
RuntimeDirectory=sshd
RuntimeDirectoryMode=0755

[Install]
WantedBy=multi-user.target
Alias=sshd.service

--

Aqui podemos ver los mÃ©todos de arranque

-D Se realiza en DETACH

**man ssh-keygen** --> Genera las claves

**ssh-keygen -A** --> Genera una nueva clave DSA.

--
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
Someone could be eavesdropping on you right now (man-in-the-middle attack)!
It is also possible that a host key has just been changed.
The fingerprint for the ECDSA key sent by the remote host is
SHA256:Ef7XHKOR9TFY6BAob5Tjo4ekZuH4DVKXh4UbeLhCGKc.
Please contact your system administrator.
Add correct host key in /root/.ssh/known_hosts to get rid of this message.
Offending ECDSA key in /root/.ssh/known_hosts:1
  remove with:
  ssh-keygen -f "/root/.ssh/known_hosts" -R "i27"
ECDSA host key for i27 has changed and you have requested strict checking.
Host key verification failed.

--

Envenenamiento de DNS.

**ssh-keygen -f "/root/.ssh/known_hosts" -R "i27"** --> REALIZAR ESTE COMANDO PARA QUE PODAMOS CONECTARNOS DE NUEVO.

--
# Host i27 found: line 1
/root/.ssh/known_hosts updated.
Original contents retained as /root/.ssh/known_hosts.old

--

--
root@pam:/opt/docker# ssh -o "VisualHostKey yes" guest@i27
The authenticity of host 'i27 (10.200.243.227)' can't be established.
ECDSA key fingerprint is SHA256:Ef7XHKOR9TFY6BAob5Tjo4ekZuH4DVKXh4UbeLhCGKc.
+---[ECDSA 256]---+
| .o.  o o o.. =+ |
| .o. o * B . = .o|
| E.   o & . = o .|
|   . + * O   * o |
|    = = S o o o  |
|   o * o . .     |
|    = o .        |
|     . .         |
|                 |
+----[SHA256]-----+
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added 'i27' (ECDSA) to the list of known hosts.
Warning: the ECDSA host key for 'i27' differs from the key for the IP address '10.200.243.227'
Offending key for IP in /root/.ssh/known_hosts:1
Are you sure you want to continue connecting (yes/no)? yes

--

El fichero de configuraciÃ³n de ssh cliente es

**vim /etc/ssh/ssh_config**

Existen 3 niveles de configuraciÃ³n de cliente:

* /etc/ssh/ssh_config **Se aplican a todos los usuarios, opciones por defecto personalizadas**
* ~/.ssh/config **Un usuario se puede redifinir sus opciones dentro de su home** **Prevale el Ãºltimo**
* opciones de la lÃ­nea de comandos

El fichero de configuraciÃ³n de ssh servidor es

**vim /etc/ssh/sshd_config**


**ssh -o [OUTPUT] guest@i27**

AquÃ­ se incluyen los parÃ¡metros

--
AddKeysToAgent=                    IdentityAgent=
AddressFamily=                     IdentityFile=
BatchMode=                         IgnoreUnknown=
BindAddress=                       Include=
CanonicalDomains=                  IPQoS=
CanonicalizeFallbackLocal=         KbdInteractiveAuthentication=

--

**vim /etc/ssh/sshd_config**

Host * --> Hace referencia a todos los hosts

Host i26 --> Hace referencia a i26i

---

VisualHostKey yes

HashKnownHosts no

--

**ssh -o "VisualHostKey no" guest@i27**

--
root@pam:/etc/ssh# ssh -o "VisualHostKey no" guest@i27
Warning: the ECDSA host key for 'i27' differs from the key for the IP address '10.200.243.227'
Offending key for IP in /root/.ssh/known_hosts:1
Matching host key in /root/.ssh/known_hosts:2
Are you sure you want to continue connecting (yes/no)? 

--

**docker exect -it pam.edt.org /bin/bash**

**su - unix01**

**ssh guest@i27**

**vim .ssh/config**


--
Host i26
	VisualHostKey yes
	PasswordAuthentication no

Host *
	VisualHostKey no
--


Se accede en modo desates.

--
Host i26
	VisualHostKey yes
	PasswordAuthentication no

Host i27
	VisualHostKey yes

Host *
	VisualHostKey no

--

Dentro de guest, guest@i27 sin cerrarlo

**ssh guest@i26**

--
guest@i27:~$ ssh guest@i26
The authenticity of host 'i26 (10.200.243.226)' can't be established.
ECDSA key fingerprint is SHA256:4qz/8/bGbpqZpC8G2j7eUaFrqwF/OvunIxwfsfv37XM.
+---[ECDSA 256]---+
|                 |
|                 |
|          .      |
|        .. .     |
|    . . So.      |
|     =o.oo       |
|     +=+=o..     |
|    ..**B=o+=  oE|
|    .+BXB@OBo...=|
+----[SHA256]-----+
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added 'i26,10.200.243.226' (ECDSA) to the list of known hosts.
guest@i26: Permission denied (publickey,password).

--

**ssh -d**

**ssh -v guest@i27**

--
OpenSSH_8.4p1 Debian-5, OpenSSL 1.1.1k  25 Mar 2021
debug1: Reading configuration data /etc/ssh/ssh_config
debug1: /etc/ssh/ssh_config line 19: include /etc/ssh/ssh_config.d/*.conf matched no files
debug1: /etc/ssh/ssh_config line 21: Applying options for *
debug1: Connecting to i27 [10.200.243.227] port 22.
debug1: Connection established.
debug1: identity file /home/unix01/.ssh/id_rsa type -1
debug1: identity file /home/unix01/.ssh/id_rsa-cert type -1
debug1: identity file /home/unix01/.ssh/id_dsa type -1
debug1: identity file /home/unix01/.ssh/id_dsa-cert type -1
debug1: identity file /home/unix01/.ssh/id_ecdsa type -1
debug1: identity file /home/unix01/.ssh/id_ecdsa-cert type -1
debug1: identity file /home/unix01/.ssh/id_ecdsa_sk type -1
debug1: identity file /home/unix01/.ssh/id_ecdsa_sk-cert type -1
debug1: identity file /home/unix01/.ssh/id_ed25519 type -1
debug1: identity file /home/unix01/.ssh/id_ed25519-cert type -1
debug1: identity file /home/unix01/.ssh/id_ed25519_sk type -1
debug1: identity file /home/unix01/.ssh/id_ed25519_sk-cert type -1
debug1: identity file /home/unix01/.ssh/id_xmss type -1
debug1: identity file /home/unix01/.ssh/id_xmss-cert type -1
debug1: Local version string SSH-2.0-OpenSSH_8.4p1 Debian-5
debug1: Remote protocol version 2.0, remote software version OpenSSH_8.4p1 Debian-5
debug1: match: OpenSSH_8.4p1 Debian-5 pat OpenSSH* compat 0x04000000
debug1: Authenticating to i27:22 as 'guest'
debug1: SSH2_MSG_KEXINIT sent
debug1: SSH2_MSG_KEXINIT received
debug1: kex: algorithm: curve25519-sha256
debug1: kex: host key algorithm: ecdsa-sha2-nistp256
debug1: kex: server->client cipher: chacha20-poly1305@openssh.com MAC: <implicit> compression: none
debug1: kex: client->server cipher: chacha20-poly1305@openssh.com MAC: <implicit> compression: none
debug1: expecting SSH2_MSG_KEX_ECDH_REPLY
debug1: Server host key: ecdsa-sha2-nistp256 SHA256:Ef7XHKOR9TFY6BAob5Tjo4ekZuH4DVKXh4UbeLhCGKc
debug1: Host 'i27' is known and matches the ECDSA host key.
debug1: Found key in /home/unix01/.ssh/known_hosts:1
Host key fingerprint is SHA256:Ef7XHKOR9TFY6BAob5Tjo4ekZuH4DVKXh4UbeLhCGKc
+---[ECDSA 256]---+
| .o.  o o o.. =+ |
| .o. o * B . = .o|
| E.   o & . = o .|
|   . + * O   * o |
|    = = S o o o  |
|   o * o . .     |
|    = o .        |
|     . .         |
|                 |
+----[SHA256]-----+
debug1: rekey out after 134217728 blocks
debug1: SSH2_MSG_NEWKEYS sent
debug1: expecting SSH2_MSG_NEWKEYS
debug1: SSH2_MSG_NEWKEYS received
debug1: rekey in after 134217728 blocks
debug1: Will attempt key: /home/unix01/.ssh/id_rsa 
debug1: Will attempt key: /home/unix01/.ssh/id_dsa 
debug1: Will attempt key: /home/unix01/.ssh/id_ecdsa 
debug1: Will attempt key: /home/unix01/.ssh/id_ecdsa_sk 
debug1: Will attempt key: /home/unix01/.ssh/id_ed25519 
debug1: Will attempt key: /home/unix01/.ssh/id_ed25519_sk 
debug1: Will attempt key: /home/unix01/.ssh/id_xmss 
debug1: SSH2_MSG_EXT_INFO received
debug1: kex_input_ext_info: server-sig-algs=<ssh-ed25519,sk-ssh-ed25519@openssh.com,ssh-rsa,rsa-sha2-256,rsa-sha2-512,ssh-dss,ecdsa-sha2-nistp256,ecdsa-sha2-nistp384,ecdsa-sha2-nistp521,sk-ecdsa-sha2-nistp256@openssh.com,webauthn-sk-ecdsa-sha2-nistp256@openssh.com>
debug1: SSH2_MSG_SERVICE_ACCEPT received
debug1: Authentications that can continue: publickey,password
debug1: Next authentication method: publickey
debug1: Trying private key: /home/unix01/.ssh/id_rsa
debug1: Trying private key: /home/unix01/.ssh/id_dsa
debug1: Trying private key: /home/unix01/.ssh/id_ecdsa
debug1: Trying private key: /home/unix01/.ssh/id_ecdsa_sk
debug1: Trying private key: /home/unix01/.ssh/id_ed25519
debug1: Trying private key: /home/unix01/.ssh/id_ed25519_sk
debug1: Trying private key: /home/unix01/.ssh/id_xmss
debug1: Next authentication method: password

--

Guest password.

debug1: SSH2_MSG_SERVICE_ACCEPT received
debug1: Authentications that can continue: publickey,password
debug1: Next authentication method: publickey




-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 
