-----------
-- SSH21 --
-----------

<!---
# Plantilla H1
## Plantilla H2
### Plantilla H3
-->
<!--- <img src="https://phoneky.co.uk/thumbs/screensavers/down/original/linux_3rj131p8.gif" />
-->

â­ï¸ **PLANTILLA** â­ï¸

| ðŸ”¥PLANTILLA TALBAâ—ðŸ”¥ | 
| ------------- |
| *Plantilla* |


--------------------------------------------------------------------------------


30.11.21 - PrÃ¡ctica 15 / PT 2

PrÃ ctica-2: PersonalitzaciÃ³ del Cloud
Aquesta prÃ ctica Ã©s una continuaciÃ³ de la prÃ ctica anterior.
1. Generar una imatge AMI propia basada en la AMI de la prÃ ctica anterior. Ha de tenir docker, docker-compose i git. Desar-la amb el nom 2hisixAMI. AixÃ­ es podran crear noves AMI basades en aquesta.

2. Assignar a la AMI de la prÃ ctica-1 una adreÃ§a IP flotant. Consultar la documentaciÃ³ prÃ²pia de AWS EC2 Floating IP per veure com es pot obtenir una adreÃ§a IP pÃºblica fixa per a un compte dâ€™usuari. Un cop obtinguda lâ€™adreÃ§a associar-la a la AMI. [FALTA]

3. Modificar interactivament el container PAM (el /etc/hosts) per apuntar a la nova
adreÃ§a IP pÃºblica del servidor LDAP.

------------------------------------------------------------------------------

30.11.21 - PrÃ¡ctica 15 / PT 3

Desplegar al Cloud amb Docker Compose un servidor LDAP, un servidor SSH i un Portainer.
Cal permetre l'accÃ©s per ssh al container ssh (per un port dedicat com per exemple el 2022) i iniciar sessiÃ³ tant dâ€™usuaris locals com dâ€™usuaris LDAP.


**USUARIO UNIX**
--
isx36579183@i11:~/.ssh$ ssh-copy-id -i id_rsa.pub -p 2022 unix01@3.95.135.98 

/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "id_rsa.pub"
The authenticity of host '[3.95.135.98]:2022 ([3.95.135.98]:2022)' can't be established.
ECDSA key fingerprint is SHA256:w4v6euuM4VM/8WXS19jWBZTdDmfiQcetvgYKe6rhmaU.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
unix01@3.95.135.98's password: 

Number of key(s) added: 1

Now try logging into the machine, with:   "ssh -p '2022' 'unix01@3.95.135.98'"
and check to make sure that only the key(s) you wanted were added.

isx36579183@i11:~/.ssh$ 

--

--
isx36579183@i11:~/.ssh$ ssh -p 2022 unix01@3.95.135.98
unix01@ssh:~$ 
--


**USUARIO DE LDAP**
--
isx36579183@i11:~/.ssh$ ssh-copy-id -i id_rsa.pub -p 2022 pere@3.95.135.98 
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "id_rsa.pub"
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
pere@3.95.135.98's password: 

Number of key(s) added: 1
```
Now try logging into the machine, with:   "ssh -p '2022' 'pere@3.95.135.98'"
and check to make sure that only the key(s) you wanted were added.

isx36579183@i11:~/.ssh$ ssh -p 2022 pere@3.95.135.98
$ pwd
/tmp/home/pere
$ id
uid=5001(pere) gid=100(users) groups=100(users),601(professors)
$ 
```
--

```
ssh-copy-id -i ./.ssh/id_rsa.pub -p 2022 pere@IP publica
```

**Desplegar a la AMI amb Docker Compose un servidor LDAP, SSH i Portainer**

**Verificar que el servei SSH del container es propaga al port 2022 del host AMI.**

**Crear el security group ssh-ldap-ssh-portainer per permetre lâ€™accÃ©s al port 2022.**

**Desplegar locament un container host PAM i configurar-lo per accedir al servidor LDAP del cloud.**

**Verificar que poden iniciar sessiÃ³ local els usuaris unix locals i tambÃ© els usuaris de LDAP.**

**Verificar que es pot iniciar sessiÃ³ remota contra el servidor SSH del cloud i iniciar sessions dâ€™usuaris locals unix dâ€™aquell host.**

**Verificar que es poden iniciar sessions remotes contra el servidor SSH del cloud i iniciar sessions remotes dâ€™usuaris de LDAP.**

**Establir un accÃ©s SSH per clau pÃºblica dâ€™un usuari local unix a un usuari remot.**

**Establir un accÃ©s SSH per clau pÃºblica dâ€™un usuari LDAP a un usuari remot.**



----------------------------------------------------------------------------------------------


#PrÃ ctica-4: Muntatge de homes via SSH

Implementar nomÃ©s per a usuaris unix locals que es munti dins del seu home una carpeta amb el seu propi nom amb el contingut del home del mateix usuari que hi ha al servidor SSH.

AixÃ­ per exemple en un host PAM local en iniciar sessiÃ³ lâ€™usuari unix01 accedeix al seu home local (creat en crear lâ€™usuari amb useradd) i dins dâ€™aquest home es crea via pam_mount un directori amb el nom de lâ€™usuari que munta per ssh el home de lâ€™usuari en el servidor SSH. Per tant tindrÃ  /home/unix01/unix01, on aquest segon unix01 Ã©s un recurs de xarxa muntat per sshfs i que correspon al home de lâ€™usuari en el servidor SSH.



Requeriments:

**Desplegar al cloud en una AMI de AWS EC2 un servidor LDAP, SSH i Portainer usant Docker Compose**

**Desplegar localment una host PAM i configurar lâ€™accÃ©s al servidor SSH modificant el fitxer /etc/hosts.**

**Configurar pam_mount per muntar nomÃ©s per als usuaris locals un recurs dins el seu home corresponent al seu directori home del servidor SSH. Aquest recurs cal muntar-lo via sshfs, ha dâ€™estar dins el seu home i sâ€™ha dâ€™anomenar igual que lâ€™usuari.**

**Trick: un punt clau per al funcionament del muntatge sshfs desatÃ¨s Ã©s que al fitxer known_hosts ja exietixi una entrada per al host destÃ­, sinÃ³ es fa la pregunta interactiva del fingerprint i no funciona el muntatge.**

**Verificar que els usuaris locals del host PAM poden iniciar sessiÃ³ local i en fer-ho es munta dins el seu home un directori amb el seu nom que Ã©s un recurs sshfs.**

**Verificar que en iniciar sessiÃ³ local al host PAM els usuaris de LDAP no es munta el recurs sshfs.**






















24.11.21 - PrÃ¡ctica 14 [SSH con Docker-compose]

1. Instalar el Docker Compose.
2. Configurar el fichero YAML.

--
version: "3.8"
services:
  ldap:
    image: keshikid03/ldap21:group
    container_name: ldap.edt.org
    hostname: ldap.edt.org
    ports: 
      - "389:389"
      - "636:636"
    networks:
     - 2hisx
  ssh:
    image: keshikid03/ssh21:base
    container_name: ssh.edt.org
    hostname: ssh.edt.org
    ports:
      - "2022:22"
    networks:
     - 2hisx
  portainer:
    image: portainer/portainer
    container_name: portainer.edt.org
    hostname: portainer.edt.org
    ports: 
     - "9000:9000"
    volumes:
     - /var/run/docker.sock:/var/run/docker.sock 
networks:
  2hisx:

--

3. Verificamos 

isx36579183@i11:~/Documents/ssh21/ssh21:base$ docker-compose up -d
Creating network "ssh21base_2hisx" with the default driver
Creating network "ssh21base_default" with the default driver
Creating ssh.edt.org       ... done
Creating portainer.edt.org ... done
Creating ldap.edt.org      ... done
isx36579183@i11:~/Documents/ssh21/ssh21:base$ docker ps
CONTAINER ID   IMAGE                     COMMAND                  CREATED          STATUS          PORTS                                                                          NAMES
2eeba994ff59   keshikid03/ssh21:base     "/bin/sh -c /opt/docâ€¦"   12 seconds ago   Up 11 seconds   0.0.0.0:2022->22/tcp, :::2022->22/tcp                                          ssh.edt.org
b7f8e122344c   keshikid03/ldap21:group   "/bin/sh -c /opt/docâ€¦"   12 seconds ago   Up 11 seconds   0.0.0.0:389->389/tcp, :::389->389/tcp, 0.0.0.0:636->636/tcp, :::636->636/tcp   ldap.edt.org
aa0ee33e0956   portainer/portainer       "/portainer"             12 seconds ago   Up 11 seconds   0.0.0.0:9000->9000/tcp, :::9000->9000/tcp                                      portainer.edt.org


25.11.21 - AWS AMI PrÃ¡ctica 15 [GRABACIÃ“N DE HOY]

1. Iniciar en AWS Educate.

2. Crear una nueva instancia (Maquina de Amazon) con nuestra AMI. Modificas y propagas los puertos necesarios 22 [SSH] 2022 [CUSTOM] y 389 [LDAP]

3. Hacer SSH a la mÃ¡quina.

ssh -i ~/.ssh/keshi-keypairDemo.pem admin@54.161.237.59

4. Preparar DOCKER con las mÃ¡quinas que vamos a utilizar. 

5. Realizamos un DOCKER LOGIN y DOCKER PULL de las mÃ¡quinas que usaremos.

6. Instalar docker-compose.

https://docs.docker.com/compose/install/ 

7. Luego hacemos un sudo docker-compose up -d

sudo docker-compose down

Para verificar.

VERIFICACIÃ“N

8. Abres todas las mÃ¡quinas.

8.1. Realizar un ldapsearch -x -LLL -h [IP LDAP] -b 'dc=edt,dc=org'

8.2. Realizar un ssh a usuario unix y a usuario ldap y haces un getent passwd.



9. Queda abrir una mÃ¡quina PAM y poder hacer SSH.

VERIFICACIÃ“N

VER VIDEO DE GRABACIÃ“N

DOCUMENTAR ASPECTOS INTERESANTES PARA VER

* PUERTOS 22:2022
* PROPAGACIÃ“N
* DESPLEGAMENT
* INSTANCIES


# PrÃ ctica-1: Desplegament al cloud

**Desplegar al Cloud, per exemple a AWS EC2 el servidor LDAP i localment desplegar un contenidor** **PAM. Configurar-lo per tal de poder autenticar usuaris de LDAP usant el servidor**
**al cloud**

## Requirements:

â— Iniciar una AMI al Cloud de AWS EC2 i assignar-li el nom 2hisix.

1. Entrar en Amazon AWS Educate --> EC2 Console --> Launch Instance --> Seleccionar nuestra AMI.

2. Crear una nueva instancia (Maquina de Amazon) con nuestra AMI. Modificas y propagas los puertos necesarios 22 [SSH] 2022 [CUSTOM] y 389 [LDAP]

3. Hacer SSH a la mÃ¡quina.

ssh -i ~/.ssh/keshi-keypairDemo.pem admin@54.161.237.59

4. Borrar las mÃ¡quinas de DOCKER que tenemos por defecto y hacer un GIT con los directorios actualizados de GIT SSH LDAP y PAM.

5. Descargar las GIT, descargar el **docker-compose** hacer un docker-compose up -d.

https://docs.docker.com/compose/install/ 


â— Desplegar al cloud el servidor LDAP, opcionalment el container PHPLdapAdmin i un
container de la imatge Portainer usant un Docker-compose.



6. Hacer un docker-compose -d / Para pararlo en docker-compose down 
Descargar las GIT, descargar el **docker-compose** hacer un docker-compose up -d.

Verificar

ssh -p 2022 unix01@localhost

ssh -p 2022 pere@localhost

ldapsearch -x -LLL -h localhost -b 'dc=edt,dc=org'

getent passwd


â— Configurar un security-wizard anomenat ssh-ldap-portainer (o ssh-ldap-php-portainer) que permeti lâ€™accÃ©s a aquests tres serveis.

2. Crear una nueva instancia (Maquina de Amazon) con nuestra AMI. Modificas y propagas los puertos necesarios 22 [SSH] 2022 [CUSTOM] y 389 [LDAP]

â— Desplegar localment un host PAM que permeti autenticaciÃ³ LDAP.

1. Abrir en la mÃ¡quina un PAM:LDAP

2. Instalar openssh-client.

3. Modificar el /etc/hosts y poner:
[IP AMAZON] aaron-AWS

4. Hacer las mismas comprobaciones.

ssh -p 2022 unix01@aaron-AWS

ssh -p 2022 pere@aaron-AWS

ldapsearch -x -LLL -h aaron-AWS -b 'dc=edt,dc=org'

getent passwd


â— Configurar interactivament el container PAM modificant el /etc/hosts per indicar
lâ€™adreÃ§a pÃºblica IP de la AMI del Cloud.

â— Verificar que el host PAM permet iniciar sessiÃ³ a usuaris locals i tambÃ© a usuaris de
LDAP.

â— Verificar que es pot accedir al servei de monitoritzaciÃ³ de Docker Portainer.

* Puerto 80 y 9000 en Wizard - Instance AWS - Configurar.
http://54.144.190.66:9000/#/init/admin 


â— Opcionalment verificar que es pot accedir al servei de PHPLdapAdmin.

[FALTA]











docker compose ps

docker compose create

docker compose start

docker compose down












**apt-get update**

**apt-get install openssh-server**

**yes**

**/usr/sbin/sshd (Daemon)** -D para DETACH

**ssh guest@i27**

**patata**

--
The authenticity of host 'i27 (10.200.243.227)' can't be established.
ECDSA key fingerprint is SHA256:N/Bx0WtXgS1RXliXUPxQFckOyooabdz6EetsEdtkC94.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added 'i27,10.200.243.227' (ECDSA) to the list of known hosts.
guest@i27's password: 
Linux i27 5.10.0-8-amd64 #1 SMP Debian 5.10.46-4 (2021-08-03) x86_64

Linux i27 5.10.0-8-amd64 #1 SMP Debian 5.10.46-4 (2021-08-03) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Wed Nov 17 08:24:41 2021 from 10.200.243.202


--

ExplicaciÃ³n: Cuando el cliente se conecta con el servidor, el servidor dice que la autenticidad del host i27 no puede estar establecida. 
La mÃ¡quina a la que has llamado, la mÃ¡quina destino tiene un **fingerprint**. 
Fingerprint vocal.
La mÃ¡quina en la que se ha conectado le ha dado un **fingerprint** en modo de **HASH**
HASH MD5 y SHA[MEDIDA]
El fingerprint real del servidor te lo tienen que decir para poder conectarse.

El cliente anota el fingerprint del servidor, si se vuelve a abrir el SSH, ya no pide le fingerprint.

El fingerprint se calcula mediante una llave. El **hash** es la clave de host.

Se almacenan en .ssh/known_hosts --> Es donde se almacenan los fingerprints de los hosts

CLIENTE ----------------> SERVIDOR

Sshclient


**vim /etc/hosts**

10.200.243.226 i27

--
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@       WARNING: POSSIBLE DNS SPOOFING DETECTED!          @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
The ECDSA host key for i27 has changed,
and the key for the corresponding IP address 10.200.243.226
is unknown. This could either mean that
DNS SPOOFING is happening or the IP address for the host
and its host key have changed at the same time.
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
Someone could be eavesdropping on you right now (man-in-the-middle attack)!
It is also possible that a host key has just been changed.
The fingerprint for the ECDSA key sent by the remote host is
SHA256:4qz/8/bGbpqZpC8G2j7eUaFrqwF/OvunIxwfsfv37XM.
Please contact your system administrator.
Add correct host key in /root/.ssh/known_hosts to get rid of this message.
Offending ECDSA key in /root/.ssh/known_hosts:1
  remove with:
  ssh-keygen -f "/root/.ssh/known_hosts" -R "i27"
ECDSA host key for i27 has changed and you have requested strict checking.
Host key verification failed.

--

Dice que han habido cambios y que te pueden estar hackeando o escuchando.

La fingerprint enviada del host es diferente a lo que tiene apuntado.


**ssh-keyscan i26**


--

isx36579183@i11:~/Documents/pam21$ ssh-keyscan i26
# i26:22 SSH-2.0-OpenSSH_8.4p1 Debian-5
i26 ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDlFgGZWfp6+uLa6qzmHDg9jT3+FrtA4tSrtrDOcnF1QTOG6FBwhdLA++XziA/PD2T7EsRXqWmtjQ3lU1+ikIyck4g52Q7VOJTlSz1YZRFh4HYCJqFLUz3BATH7scESqXv8NzVcilQy+5KfIQCSYtP55rZ2hcxHNgjEfHFEIjaQrJRwW+D13senMrh+VaFDdZtziiKvvSjwrmLoGbcxBFhQf2jk/b+yBBZhqfwixlpXb4f5lDzNNS+f+jAIA/jPUpSxzMtzwroIaG3CJMnfBQdkd3UjN9T88VBUxvBVC6UbypSRYZsPoRWUuC4iTwRmIHy/qP6zXwXXFz6+VQ1T6HBbXWGpsAApohNVzRgly/APxmm/gvH8XDmNE4Vu9ltQN+nltBi5c8gkTSfhnVGViL9oqdHiCg5+zoaGyt4OEfqUMZXnIKF1ws2BmP9EdNRQg7IOs+N26BMGIBFJo8afFgxqDvrRyOj5R3dcVjMs6jXUHbp+aSjh/s936xdAbU+9Fm8=
# i26:22 SSH-2.0-OpenSSH_8.4p1 Debian-5
i26 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBP7OkfWoUX+gRX2KyQvPC/5yCC52UUOAzFmyMZrq2gEsbJV+K1XkY6Xc/wbzANH2Plosd86o+xtWz0M9UzvaFd4=
# i26:22 SSH-2.0-OpenSSH_8.4p1 Debian-5
i26 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINs01uNs6AU52uwYhNVCBvYihQcSMeTYo1QHRHMT1Wel
# i26:22 SSH-2.0-OpenSSH_8.4p1 Debian-5
# i26:22 SSH-2.0-OpenSSH_8.4p1 Debian-5

--

Dice las claves de host de SSH de i26

Cuando se ha instalado el Openssh-server, se han creado automÃ¡ticamente las claves de host.

known_hosts --> Es la lista de fingerprints, que el usuario ha dado como aceptables a la hora de entrar. Es decir que ha aceptado el fingerprint del servidor.

**cat ~/.ssh/known_hosts**

--
|1|W6RPlVuD8uqOVw7sLDCyMFKPoPA=|rQ8QEG+54oC1/tPVnPJ7rdgUhbg= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMzAza02PRtaaYGcGC5KJCmh1uUReCUBU5V8mcIgOCeTGFlpM5l1n5YO4MxrvOLa5i3gbolZ9hArCD7MYAzRGwY=
|1|ms4ytWDTbvB59PgBA4K5ZN1siME=|o/qR3IPIxeFPbAq0gYowmcJlF30= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMzAza02PRtaaYGcGC5KJCmh1uUReCUBU5V8mcIgOCeTGFlpM5l1n5YO4MxrvOLa5i3gbolZ9hArCD7MYAzRGwY=

--

**md5sum /etc/passwd**
--
0cd28cd36e0974a41545b1fb9c2598b1  /etc/passwd

--
Es el hash de todo /etc/passwd


Si se cambia algo se cambia el fingerprint.

--
root@pam:/opt/docker# md5sum /tmp/passwd
0cd28cd36e0974a41545b1fb9c2598b1  /tmp/passwd
root@pam:/opt/docker# md5sum /tmp/passwd
0cd28cd36e0974a41545b1fb9c2598b1  /tmp/passwd
root@pam:/opt/docker# vim /tmp/passwd
root@pam:/opt/docker# md5sum /tmp/passwd
98e0e82968fc92e2fd68ccf4768ed161  /tmp/passwd

--

Checksum --> Retransmitir, de la suma.

DispersiÃ³n --> Mucha cantidad de datos y concentras en algo mÃ¡s pequeÃ±o. Hay 

Eliminar ultima lines del etc hosts. Entrar a i27:
root@pam:/opt/docker# ssh -o "VisualHostKey yes" guest@i27
: patata
$ su -
:jupiter
# cd /etc/ssh/
# tree


--
Host key fingerprint is SHA256:N/Bx0WtXgS1RXliXUPxQFckOyooabdz6EetsEdtkC94
+---[ECDSA 256]---+
|            .+XO%|
|             ==*+|
|        . o o ++o|
|         = B  o.o|
|      o S.& .. . |
|     . = BoE     |
|      + .o.      |
|     . .o..      |
|        o+       |
+----[SHA256]-----+
guest@i27's password: 
Linux i27 5.10.0-8-amd64 #1 SMP Debian 5.10.46-4 (2021-08-03) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Wed Nov 17 09:00:06 2021 from 10.200.243.209
guest@i27:~$ 

--

su - # jupiter

--
.
â”œâ”€â”€ moduli
â”œâ”€â”€ ssh_config
â”œâ”€â”€ ssh_config.d
â”œâ”€â”€ sshd_config
â”œâ”€â”€ sshd_config.d
â”œâ”€â”€ ssh_host_ecdsa_key
â”œâ”€â”€ ssh_host_ecdsa_key.pub
â”œâ”€â”€ ssh_host_ed25519_key
â”œâ”€â”€ ssh_host_ed25519_key.pub
â”œâ”€â”€ ssh_host_rsa_key
â””â”€â”€ ssh_host_rsa_key.pub

--

apt-get install mlocate (Lo hace solo el host)

**locate ssh.service**
--
/usr/lib/systemd/system/ssh.service
/usr/lib/systemd/system/sssd-ssh.service
/usr/share/doc/avahi-daemon/examples/sftp-ssh.service
/usr/share/doc/avahi-daemon/examples/ssh.service
/var/lib/systemd/deb-systemd-helper-enabled/ssh.service.dsh-also
/var/lib/systemd/deb-systemd-helper-enabled/sssd-ssh.service.dsh-also
/var/lib/systemd/deb-systemd-helper-enabled/multi-user.target.wants/ssh.service

--

**vim /usr/lib/systemd/system/ssh.service**

--
[Unit]
Description=OpenBSD Secure Shell server
Documentation=man:sshd(8) man:sshd_config(5)
After=network.target auditd.service
ConditionPathExists=!/etc/ssh/sshd_not_to_be_run

[Service]
EnvironmentFile=-/etc/default/ssh
ExecStartPre=/usr/sbin/sshd -t
ExecStart=/usr/sbin/sshd -D $SSHD_OPTS
ExecReload=/usr/sbin/sshd -t
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
Restart=on-failure
RestartPreventExitStatus=255
Type=notify
RuntimeDirectory=sshd
RuntimeDirectoryMode=0755

[Install]
WantedBy=multi-user.target
Alias=sshd.service

--

Aqui podemos ver los mÃ©todos de arranque

-D Se realiza en DETACH

**man ssh-keygen** --> Genera las claves

**ssh-keygen -A** --> Genera una nueva clave DSA.

--
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
Someone could be eavesdropping on you right now (man-in-the-middle attack)!
It is also possible that a host key has just been changed.
The fingerprint for the ECDSA key sent by the remote host is
SHA256:Ef7XHKOR9TFY6BAob5Tjo4ekZuH4DVKXh4UbeLhCGKc.
Please contact your system administrator.
Add correct host key in /root/.ssh/known_hosts to get rid of this message.
Offending ECDSA key in /root/.ssh/known_hosts:1
  remove with:
  ssh-keygen -f "/root/.ssh/known_hosts" -R "i27"
ECDSA host key for i27 has changed and you have requested strict checking.
Host key verification failed.

--

Envenenamiento de DNS.

**ssh-keygen -f "/root/.ssh/known_hosts" -R "i27"** --> REALIZAR ESTE COMANDO PARA QUE PODAMOS CONECTARNOS DE NUEVO.

--
# Host i27 found: line 1
/root/.ssh/known_hosts updated.
Original contents retained as /root/.ssh/known_hosts.old

--

--
root@pam:/opt/docker# ssh -o "VisualHostKey yes" guest@i27
The authenticity of host 'i27 (10.200.243.227)' can't be established.
ECDSA key fingerprint is SHA256:Ef7XHKOR9TFY6BAob5Tjo4ekZuH4DVKXh4UbeLhCGKc.
+---[ECDSA 256]---+
| .o.  o o o.. =+ |
| .o. o * B . = .o|
| E.   o & . = o .|
|   . + * O   * o |
|    = = S o o o  |
|   o * o . .     |
|    = o .        |
|     . .         |
|                 |
+----[SHA256]-----+
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added 'i27' (ECDSA) to the list of known hosts.
Warning: the ECDSA host key for 'i27' differs from the key for the IP address '10.200.243.227'
Offending key for IP in /root/.ssh/known_hosts:1
Are you sure you want to continue connecting (yes/no)? yes

--

El fichero de configuraciÃ³n de ssh cliente es

**vim /etc/ssh/ssh_config**

Existen 3 niveles de configuraciÃ³n de cliente:

* /etc/ssh/ssh_config **Se aplican a todos los usuarios, opciones por defecto personalizadas**
* ~/.ssh/config **Un usuario se puede redifinir sus opciones dentro de su home** **Prevale el Ãºltimo**
* opciones de la lÃ­nea de comandos

El fichero de configuraciÃ³n de ssh servidor es

**vim /etc/ssh/sshd_config**


**ssh -o [OUTPUT] guest@i27**

AquÃ­ se incluyen los parÃ¡metros

--
AddKeysToAgent=                    IdentityAgent=
AddressFamily=                     IdentityFile=
BatchMode=                         IgnoreUnknown=
BindAddress=                       Include=
CanonicalDomains=                  IPQoS=
CanonicalizeFallbackLocal=         KbdInteractiveAuthentication=

--

**vim /etc/ssh/sshd_config**

Host * --> Hace referencia a todos los hosts

Host i26 --> Hace referencia a i26i

---

VisualHostKey yes

HashKnownHosts no

--

**ssh -o "VisualHostKey no" guest@i27**

--
root@pam:/etc/ssh# ssh -o "VisualHostKey no" guest@i27
Warning: the ECDSA host key for 'i27' differs from the key for the IP address '10.200.243.227'
Offending key for IP in /root/.ssh/known_hosts:1
Matching host key in /root/.ssh/known_hosts:2
Are you sure you want to continue connecting (yes/no)? 

--

**docker exect -it pam.edt.org /bin/bash**

**su - unix01**

**ssh guest@i27**

**vim .ssh/config**


--
Host i26
	VisualHostKey yes
	PasswordAuthentication no

Host *
	VisualHostKey no
--


Se accede en modo desates.

--
Host i26
	VisualHostKey yes
	PasswordAuthentication no

Host i27
	VisualHostKey yes

Host *
	VisualHostKey no

--

Dentro de guest, guest@i27 sin cerrarlo

**ssh guest@i26**

--
guest@i27:~$ ssh guest@i26
The authenticity of host 'i26 (10.200.243.226)' can't be established.
ECDSA key fingerprint is SHA256:4qz/8/bGbpqZpC8G2j7eUaFrqwF/OvunIxwfsfv37XM.
+---[ECDSA 256]---+
|                 |
|                 |
|          .      |
|        .. .     |
|    . . So.      |
|     =o.oo       |
|     +=+=o..     |
|    ..**B=o+=  oE|
|    .+BXB@OBo...=|
+----[SHA256]-----+
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added 'i26,10.200.243.226' (ECDSA) to the list of known hosts.
guest@i26: Permission denied (publickey,password).

--

**ssh -d**

**ssh -v guest@i27**

--
OpenSSH_8.4p1 Debian-5, OpenSSL 1.1.1k  25 Mar 2021
debug1: Reading configuration data /etc/ssh/ssh_config
debug1: /etc/ssh/ssh_config line 19: include /etc/ssh/ssh_config.d/*.conf matched no files
debug1: /etc/ssh/ssh_config line 21: Applying options for *
debug1: Connecting to i27 [10.200.243.227] port 22.
debug1: Connection established.
debug1: identity file /home/unix01/.ssh/id_rsa type -1
debug1: identity file /home/unix01/.ssh/id_rsa-cert type -1
debug1: identity file /home/unix01/.ssh/id_dsa type -1
debug1: identity file /home/unix01/.ssh/id_dsa-cert type -1
debug1: identity file /home/unix01/.ssh/id_ecdsa type -1
debug1: identity file /home/unix01/.ssh/id_ecdsa-cert type -1
debug1: identity file /home/unix01/.ssh/id_ecdsa_sk type -1
debug1: identity file /home/unix01/.ssh/id_ecdsa_sk-cert type -1
debug1: identity file /home/unix01/.ssh/id_ed25519 type -1
debug1: identity file /home/unix01/.ssh/id_ed25519-cert type -1
debug1: identity file /home/unix01/.ssh/id_ed25519_sk type -1
debug1: identity file /home/unix01/.ssh/id_ed25519_sk-cert type -1
debug1: identity file /home/unix01/.ssh/id_xmss type -1
debug1: identity file /home/unix01/.ssh/id_xmss-cert type -1
debug1: Local version string SSH-2.0-OpenSSH_8.4p1 Debian-5
debug1: Remote protocol version 2.0, remote software version OpenSSH_8.4p1 Debian-5
debug1: match: OpenSSH_8.4p1 Debian-5 pat OpenSSH* compat 0x04000000
debug1: Authenticating to i27:22 as 'guest'
debug1: SSH2_MSG_KEXINIT sent
debug1: SSH2_MSG_KEXINIT received
debug1: kex: algorithm: curve25519-sha256
debug1: kex: host key algorithm: ecdsa-sha2-nistp256
debug1: kex: server->client cipher: chacha20-poly1305@openssh.com MAC: <implicit> compression: none
debug1: kex: client->server cipher: chacha20-poly1305@openssh.com MAC: <implicit> compression: none
debug1: expecting SSH2_MSG_KEX_ECDH_REPLY
debug1: Server host key: ecdsa-sha2-nistp256 SHA256:Ef7XHKOR9TFY6BAob5Tjo4ekZuH4DVKXh4UbeLhCGKc
debug1: Host 'i27' is known and matches the ECDSA host key.
debug1: Found key in /home/unix01/.ssh/known_hosts:1
Host key fingerprint is SHA256:Ef7XHKOR9TFY6BAob5Tjo4ekZuH4DVKXh4UbeLhCGKc
+---[ECDSA 256]---+
| .o.  o o o.. =+ |
| .o. o * B . = .o|
| E.   o & . = o .|
|   . + * O   * o |
|    = = S o o o  |
|   o * o . .     |
|    = o .        |
|     . .         |
|                 |
+----[SHA256]-----+
debug1: rekey out after 134217728 blocks
debug1: SSH2_MSG_NEWKEYS sent
debug1: expecting SSH2_MSG_NEWKEYS
debug1: SSH2_MSG_NEWKEYS received
debug1: rekey in after 134217728 blocks
debug1: Will attempt key: /home/unix01/.ssh/id_rsa 
debug1: Will attempt key: /home/unix01/.ssh/id_dsa 
debug1: Will attempt key: /home/unix01/.ssh/id_ecdsa 
debug1: Will attempt key: /home/unix01/.ssh/id_ecdsa_sk 
debug1: Will attempt key: /home/unix01/.ssh/id_ed25519 
debug1: Will attempt key: /home/unix01/.ssh/id_ed25519_sk 
debug1: Will attempt key: /home/unix01/.ssh/id_xmss 
debug1: SSH2_MSG_EXT_INFO received
debug1: kex_input_ext_info: server-sig-algs=<ssh-ed25519,sk-ssh-ed25519@openssh.com,ssh-rsa,rsa-sha2-256,rsa-sha2-512,ssh-dss,ecdsa-sha2-nistp256,ecdsa-sha2-nistp384,ecdsa-sha2-nistp521,sk-ecdsa-sha2-nistp256@openssh.com,webauthn-sk-ecdsa-sha2-nistp256@openssh.com>
debug1: SSH2_MSG_SERVICE_ACCEPT received
debug1: Authentications that can continue: publickey,password
debug1: Next authentication method: publickey
debug1: Trying private key: /home/unix01/.ssh/id_rsa
debug1: Trying private key: /home/unix01/.ssh/id_dsa
debug1: Trying private key: /home/unix01/.ssh/id_ecdsa
debug1: Trying private key: /home/unix01/.ssh/id_ecdsa_sk
debug1: Trying private key: /home/unix01/.ssh/id_ed25519
debug1: Trying private key: /home/unix01/.ssh/id_ed25519_sk
debug1: Trying private key: /home/unix01/.ssh/id_xmss
debug1: Next authentication method: password

--

Guest password.

debug1: SSH2_MSG_SERVICE_ACCEPT received
debug1: Authentications that can continue: publickey,password
debug1: Next authentication method: publickey




-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 



















-------------------------------------------------------------------------------- 
